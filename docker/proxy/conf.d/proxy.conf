# Health check endpoint
server {
    listen 80 default_server;
    server_name _;

    location = /healthz {
        add_header Content-Type text/plain;
        return 200 "proxy-ok\n";
    }

    # Default catch-all - should not be reached if domains are configured
    location / {
        return 444;  # Close connection without response
    }
}

# Production: nazim.cloud (HTTP)
server {
    listen 80;
    server_name nazim.cloud www.nazim.cloud;

    client_max_body_size 50M;

    # Health endpoint
    location = /healthz {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    # ACME challenge for Let's Encrypt (if proxy manages certs)
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # If HTTPS cert exists, redirect to HTTPS
    location / {
        if (-f /etc/letsencrypt/proxy/live/nazim.cloud/fullchain.pem) {
            return 301 https://$host$request_uri;
        }

        # Forward to production nginx (internal)
        # Use variable for dynamic DNS resolution at request time
        set $prod_upstream http://nazim_prod_nginx:80;
        proxy_pass $prod_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# Production: nazim.cloud (HTTPS)
server {
     listen 443 ssl;
     http2 on;
     server_name nazim.cloud www.nazim.cloud;

     client_max_body_size 50M;

     # SSL certificates (proxy-managed or use production certs)
     # Option 1: Use proxy-managed certificates
     ssl_certificate /etc/letsencrypt/proxy/live/nazim.cloud/fullchain.pem;
     ssl_certificate_key /etc/letsencrypt/proxy/live/nazim.cloud/privkey.pem;
     
     # Option 2: Use production certificates (if available)
     # ssl_certificate /etc/letsencrypt/prod/live/nazim.cloud/fullchain.pem;
     # ssl_certificate_key /etc/letsencrypt/prod/live/nazim.cloud/privkey.pem;

     # SSL configuration
     ssl_protocols TLSv1.2 TLSv1.3;
     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA256';
     ssl_prefer_server_ciphers off;
     ssl_session_cache shared:SSL:10m;
     ssl_session_timeout 10m;

     # Health endpoint
     location = /healthz {
         add_header Content-Type text/plain;
         return 200 "ok\n";
     }

     # Forward to production nginx (internal, HTTP - proxy does SSL termination)
     location / {
         # Use variable for dynamic DNS resolution at request time
         set $prod_upstream http://nazim_prod_nginx:80;
         proxy_pass $prod_upstream;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Proto https;
         proxy_set_header X-Forwarded-Host $host;
         proxy_set_header X-Forwarded-Port 443;
         
         # Timeouts
         proxy_connect_timeout 60s;
         proxy_send_timeout 60s;
         proxy_read_timeout 60s;
     }
 }

# Demo: demo.nazim.cloud (HTTP)
server {
    listen 80;
    server_name demo.nazim.cloud;

    client_max_body_size 50M;

    # Health endpoint
    location = /healthz {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    # ACME challenge for Let's Encrypt (if proxy manages certs)
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # If HTTPS cert exists, redirect to HTTPS
    location / {
        if (-f /etc/letsencrypt/proxy/live/demo.nazim.cloud/fullchain.pem) {
            return 301 https://$host$request_uri;
        }

        # Forward to demo nginx (internal, port 80)
        # Use variable for dynamic DNS resolution at request time
        set $demo_upstream http://nazim_demo_nginx:80;
        proxy_pass $demo_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# Demo: demo.nazim.cloud (HTTPS)
server {
     listen 443 ssl;
     http2 on;
     server_name demo.nazim.cloud;

     client_max_body_size 50M;

     # SSL certificates (proxy-managed or use demo certs)
     # Option 1: Use proxy-managed certificates
     ssl_certificate /etc/letsencrypt/proxy/live/demo.nazim.cloud/fullchain.pem;
     ssl_certificate_key /etc/letsencrypt/proxy/live/demo.nazim.cloud/privkey.pem;
     
     # Option 2: Use demo certificates (if available)
     # ssl_certificate /etc/letsencrypt/demo/live/demo.nazim.cloud/fullchain.pem;
     # ssl_certificate_key /etc/letsencrypt/demo/live/demo.nazim.cloud/privkey.pem;

     # SSL configuration
     ssl_protocols TLSv1.2 TLSv1.3;
     ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA256';
     ssl_prefer_server_ciphers off;
     ssl_session_cache shared:SSL:10m;
     ssl_session_timeout 10m;

     # Health endpoint
     location = /healthz {
         add_header Content-Type text/plain;
         return 200 "ok\n";
     }

     # Forward to demo nginx (internal, HTTP - proxy does SSL termination)
     location / {
         # Use variable for dynamic DNS resolution at request time
         set $demo_upstream http://nazim_demo_nginx:80;
         proxy_pass $demo_upstream;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Proto https;
         proxy_set_header X-Forwarded-Host $host;
         proxy_set_header X-Forwarded-Port 443;
         
         # Timeouts
         proxy_connect_timeout 60s;
         proxy_send_timeout 60s;
         proxy_read_timeout 60s;
     }
}

