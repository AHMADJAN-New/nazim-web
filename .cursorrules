# Nazim School Management System - Cursor Rules

## Project Overview
This is a comprehensive Islamic school management system built with React, TypeScript, and Supabase. The application serves educational institutions with features for student management, academics, finance, communication, and more.

## Tech Stack
- **Frontend**: React 18.3.1, TypeScript, Vite, Tailwind CSS, shadcn/ui
- **Backend**: Supabase (PostgreSQL, Auth, Storage, Edge Functions)
- **State Management**: TanStack Query (React Query)
- **Routing**: React Router DOM v6
- **Forms**: React Hook Form + Zod validation
- **Charts**: Recharts
- **Testing**: Vitest, Testing Library

## Code Style & Standards

### TypeScript
- Use strict TypeScript with proper type definitions
- Define interfaces for all data structures
- Use generic types where appropriate
- Avoid `any` type - use proper typing
- Export types from dedicated type files

### React Patterns
- Use functional components with hooks
- Implement proper error boundaries
- Use React.memo for performance optimization
- Follow React best practices for state management
- Use custom hooks for reusable logic

### File Organization
- Components in `/src/components/`
- Pages in `/src/pages/`
- Hooks in `/src/hooks/`
- Types in `/src/types/`
- Utils in `/src/lib/`
- Use index files for clean imports

### Naming Conventions
- Components: PascalCase (e.g., `StudentDashboard`)
- Files: PascalCase for components, camelCase for utilities
- Variables: camelCase
- Constants: UPPER_SNAKE_CASE
- Database tables: snake_case

## Database & Supabase

### Database Schema
- Use proper foreign key relationships
- Implement Row Level Security (RLS)
- Use enums for status fields
- Follow naming conventions: snake_case for tables/columns

### Supabase Integration
- Use typed Supabase client
- Implement proper error handling
- Use real-time subscriptions where needed
- Follow security best practices

### Query Patterns
```typescript
// Use TanStack Query for data fetching
const { data, isLoading, error } = useQuery({
  queryKey: ['students', page, search],
  queryFn: () => fetchStudents({ page, search }),
  staleTime: 5 * 60 * 1000, // 5 minutes
});
```

## UI/UX Guidelines

### Design System
- Use shadcn/ui components consistently
- Follow Islamic-inspired design principles
- Implement responsive design (mobile-first)
- Support RTL languages (Arabic, Pashto, Farsi)
- Use semantic color tokens

### Component Structure
```typescript
interface ComponentProps {
  // Define all props with proper types
}

export function ComponentName({ prop1, prop2 }: ComponentProps) {
  // Component logic
  return (
    <div className="proper-tailwind-classes">
      {/* JSX content */}
    </div>
  );
}
```

### Styling
- Use Tailwind CSS utility classes
- Create custom CSS variables for theming
- Implement dark/light mode support
- Use consistent spacing and typography
- Follow accessibility guidelines

## Internationalization (i18n)

### Language Support
- **Supported Languages**: English (en), Pashto (ps), Farsi (fa), Arabic (ar)
- **RTL Languages**: Arabic, Pashto, Farsi
- **LTR Languages**: English

### Translation System
- All translations are stored in `/src/lib/i18n.ts`
- Use the `useLanguage` hook to access translations
- Translation keys follow a hierarchical structure: `category.key` (e.g., `students.title`, `nav.dashboard`)

### Using Translations
```typescript
import { useLanguage } from '@/hooks/useLanguage';

function MyComponent() {
  const { t, isRTL, language } = useLanguage();
  
  return (
    <div>
      <h1>{t('students.title')}</h1>
      <p>{t('students.searchPlaceholder')}</p>
    </div>
  );
}
```

### Translation Key Structure
- **Common**: `common.loading`, `common.save`, `common.cancel`, etc.
- **Navigation**: `nav.dashboard`, `nav.students`, `nav.allStudents`, etc.
- **Students**: `students.title`, `students.management`, `students.addStudent`, etc.
- **Dashboard**: `dashboard.title`, `dashboard.totalStudents`, etc.
- **Forms**: `forms.required`, `forms.invalidEmail`, etc.

### Adding New Translations
1. Add the key to the `TranslationKeys` interface in `/src/lib/i18n.ts`
2. Add translations for all languages (en, ps, fa, ar)
3. Use the key in components with `t('category.key')`

### RTL (Right-to-Left) Support

#### Implementation
- RTL is automatically applied when an RTL language is selected
- The `useLanguage` hook sets `document.documentElement.dir` to `'rtl'` or `'ltr'`
- Sidebar position changes based on RTL: `side={isRTL ? "right" : "left"}`
- Layout direction is set via `dir` attribute on main containers

#### RTL CSS Rules
- RTL-specific CSS is in `/src/index.css` under `[dir="rtl"]` selectors
- Text alignment automatically reverses: `.text-left` becomes right-aligned in RTL
- Auto margins reverse: `.ml-auto` becomes `margin-right: auto` in RTL
- Borders adjust: `.border-l` becomes right border in RTL

#### Component RTL Handling
```typescript
// In components, use isRTL from useLanguage hook
const { isRTL } = useLanguage();

// Apply conditional classes
<div className={isRTL ? 'mr-4 border-r' : 'ml-4 border-l'}>
  {/* Content */}
</div>

// Sidebar component
<Sidebar side={isRTL ? "right" : "left"} dir={isRTL ? 'rtl' : 'ltr'}>
  {/* Sidebar content */}
</Sidebar>
```

#### Navigation Items with Translations
- Navigation items should use `titleKey` for translation keys
- Children items should have `titleKey` property for translations
- Example:
```typescript
{
  title: "All Students", // Fallback
  titleKey: "allStudents", // Translation key
  url: "/students",
  icon: Users
}
```

### Language Provider
- `LanguageProvider` wraps the entire app in `App.tsx`
- Language preference is stored in `localStorage` with key `'nazim-language'`
- Default language is English (`'en'`)
- Language switcher is available in both sidebar and header

## Authentication & Security

### User Roles
- `super_admin`: Full system access
- `admin`: School-level administration
- `teacher`: Academic management
- `staff`: Operational tasks
- `student`: Personal academic access
- `parent`: Child's academic information

### Security Practices
- Implement proper role-based access control
- Use JWT tokens for authentication
- Validate all user inputs
- Implement audit logging
- Follow OWASP security guidelines

### Development Mode Auth Bypass
- In development, authentication can be bypassed using `VITE_DISABLE_AUTH` env variable
- Mock user is created with `admin` role
- This should NEVER be enabled in production

## Performance Optimization

### Code Splitting
- Use lazy loading for all pages
- Implement proper loading states
- Use Suspense boundaries
- Optimize bundle size

### Data Fetching
- Use TanStack Query for caching
- Default `staleTime`: 5 minutes
- Default `gcTime`: 10 minutes
- Set `refetchOnWindowFocus: false` and `refetchOnMount: false` for better performance
- Implement proper loading states
- Use optimistic updates where appropriate
- Implement error boundaries

### Rendering
- Use React.memo for expensive components
- Implement proper key props
- Avoid unnecessary re-renders
- Use useMemo and useCallback appropriately
- Memoize filtered lists and calculations

### Loading States
- Use unified loading components from `/src/components/ui/loading.tsx`
- `LoadingSpinner`: For general loading states
- `PageSkeleton`: For page-level loading
- `DashboardSkeleton`: For dashboard loading
- `TableSkeleton`: For table loading
- All loaders use consistent styling (centered spinner with border)

## Testing Strategy

### Unit Tests
- Test component rendering
- Test user interactions
- Test custom hooks
- Test utility functions

### Integration Tests
- Test API integrations
- Test database operations
- Test authentication flows
- Test role-based access

### Test Structure
```typescript
describe('ComponentName', () => {
  it('should render correctly', () => {
    // Test implementation
  });
  
  it('should handle user interactions', () => {
    // Test implementation
  });
});
```

## Error Handling

### Client-Side
- Use error boundaries for component errors
- Implement proper error states
- Show user-friendly error messages
- Log errors for debugging

### Server-Side
- Handle Supabase errors gracefully
- Implement retry logic where appropriate
- Use proper HTTP status codes
- Log errors for monitoring

## Code Quality

### Linting & Formatting
- Use ESLint for code quality
- Use Prettier for code formatting
- Follow consistent code style
- Remove unused imports and variables

### Documentation
- Write clear component documentation
- Use JSDoc for complex functions
- Document API endpoints
- Keep README updated

## Git Workflow

### Commit Messages
- Use conventional commit format
- Be descriptive and clear
- Reference issues where applicable
- Keep commits atomic

### Branch Strategy
- Use feature branches for new features
- Use descriptive branch names
- Keep branches up to date
- Use pull requests for code review

## Deployment

### Environment Variables
- Use proper environment configuration
- Never commit sensitive data
- Use different configs for dev/prod
- Document required environment variables

### Build Process
- Use Vite for fast builds
- Optimize bundle size
- Implement proper caching
- Use CDN for static assets

## Common Patterns

### Data Fetching
```typescript
// Custom hook pattern
export const useStudents = (params: StudentParams) => {
  return useQuery({
    queryKey: ['students', params],
    queryFn: () => fetchStudents(params),
    enabled: !!params.classId,
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
  });
};
```

### Form Handling
```typescript
// React Hook Form + Zod
const form = useForm<StudentFormData>({
  resolver: zodResolver(studentSchema),
  defaultValues: {
    // Default values
  },
});
```

### State Management
```typescript
// Local state
const [isLoading, setIsLoading] = useState(false);

// Server state
const { data, isLoading, error } = useQuery({
  queryKey: ['key'],
  queryFn: fetchFunction,
});
```

### Translation Usage
```typescript
// Always use useLanguage hook
const { t, isRTL, language } = useLanguage();

// Use translation keys
<h1>{t('students.title')}</h1>
<Button>{t('common.save')}</Button>

// Check RTL for conditional styling
<div className={isRTL ? 'text-right' : 'text-left'}>
  {t('students.searchPlaceholder')}
</div>
```

## Layout & Navigation

### Persistent Layout
- `PersistentLayout` component provides sidebar and header for all protected routes
- Sidebar persists across route changes (SPA behavior)
- Layout respects RTL direction
- Sidebar position changes based on language direction

### Sidebar Navigation
- `SmartSidebar` component handles navigation
- Navigation items are filtered by user role
- All navigation items use translation keys
- Children items should have `titleKey` for translations
- Sidebar collapses/expands with icon-only mode

## Islamic School Specific Guidelines

### Hifz Progress
- Track Quran memorization progress
- Implement proper Arabic text handling
- Support different memorization methods
- Provide progress analytics

### Academic Calendar
- Support Islamic calendar
- Handle prayer times
- Implement holiday management
- Support different academic years

### Communication
- Support multiple languages
- Implement proper notification systems
- Handle parent-teacher communication
- Support SMS and email integration

## Performance Monitoring

### Metrics to Track
- Page load times
- API response times
- User interaction metrics
- Error rates
- Database query performance

### Optimization
- Use React DevTools Profiler
- Monitor bundle size
- Implement proper caching
- Use performance budgets

## Security Considerations

### Data Protection
- Encrypt sensitive data
- Implement proper access controls
- Use HTTPS everywhere
- Regular security audits

### User Privacy
- Follow GDPR guidelines
- Implement data retention policies
- Provide data export functionality
- Allow data deletion

## Accessibility

### WCAG Guidelines
- Use semantic HTML
- Implement proper ARIA labels
- Ensure keyboard navigation
- Provide alt text for images
- Use proper color contrast

### Testing
- Test with screen readers
- Test keyboard navigation
- Test with different zoom levels
- Test with high contrast mode

## Maintenance

### Code Reviews
- Review for security issues
- Check performance implications
- Ensure proper error handling
- Verify accessibility compliance
- Verify translations are used correctly
- Check RTL layout correctness

### Updates
- Keep dependencies updated
- Monitor security advisories
- Test updates thoroughly
- Document breaking changes

## Troubleshooting

### Common Issues
- Authentication problems
- Database connection issues
- Performance problems
- Browser compatibility
- Translation keys not found (check key spelling and language files)
- RTL layout issues (check `dir` attribute and CSS)

### Debugging
- Use browser dev tools
- Implement proper logging
- Use React DevTools
- Monitor network requests
- Check translation keys in console: `t('key')` should return translated string
- Verify RTL: Check `document.documentElement.dir` in console

Remember: This is a production application serving real educational institutions. Always prioritize security, performance, and user experience in your code. Always use translations for user-facing text, and ensure RTL support is properly implemented.
