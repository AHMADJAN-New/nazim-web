/* eslint-disable no-console */
/**
 * Generates a flat union type for translation keys WITHOUT recursive TS types.
 *
 * Source of truth: EN translation object keys (flattened dot-keys).
 *
 * Output (committed):
 *   frontend/src/lib/translations/keys.generated.ts
 *
 * Run:
 *   npm run i18n:keys:generate
 */

/// <reference types="node" />

import fs from 'fs/promises';
import path from 'path';

import { en } from '../../src/lib/translations/en';

function isPlainObject(value: unknown): value is Record<string, unknown> {
  return typeof value === 'object' && value !== null && !Array.isArray(value);
}

function flattenToDotKeys(obj: unknown): string[] {
  const out: string[] = [];

  function walk(value: unknown, prefix: string) {
    if (typeof value === 'string') {
      if (prefix) out.push(prefix);
      return;
    }
    if (!isPlainObject(value)) return;

    for (const [k, v] of Object.entries(value)) {
      const next = prefix ? `${prefix}.${k}` : k;
      walk(v, next);
    }
  }

  walk(obj, '');
  return out.sort((a, b) => a.localeCompare(b));
}

function asTsStringLiteral(s: string): string {
  return JSON.stringify(s);
}

async function main() {
  const cwd = process.cwd(); // expected: .../frontend
  const outFile = path.resolve(cwd, 'src/lib/translations/keys.generated.ts');
  const keys = flattenToDotKeys(en);

  const header = `/**
 * AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.
 *
 * Generated by: frontend/scripts/i18n/generate-translation-keys.ts
 * Source: EN translation object (frontend/src/lib/translations/en.ts)
 *
 * Purpose:
 * - Provide fast, flat key autocomplete and type-safety for t('...')
 * - Avoid TS recursive type depth issues on large translation trees
 *
 * Regenerate:
 *   npm run i18n:keys:generate
 */
`;

  const lines: string[] = [];
  lines.push(header.trimEnd());
  lines.push('');
  lines.push('export const TRANSLATION_KEYS = [');
  for (const k of keys) {
    lines.push(`  ${asTsStringLiteral(k)},`);
  }
  lines.push('] as const;');
  lines.push('');
  lines.push('export type TranslationKey = typeof TRANSLATION_KEYS[number];');
  lines.push('');

  await fs.mkdir(path.dirname(outFile), { recursive: true });
  await fs.writeFile(outFile, lines.join('\n') + '\n', 'utf8');

  console.log(`[i18n:keys] Wrote ${path.relative(cwd, outFile)} (${keys.length} keys)`);
}

main().catch((err) => {
  console.error('[i18n:keys] Unhandled error:', err);
  process.exit(1);
});


